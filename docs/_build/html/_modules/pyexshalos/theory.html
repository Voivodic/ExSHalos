
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyexshalos.theory &#8212; ExSHalos 0.1.0</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=a1637f0b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pyexshalos/theory';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ExSHalos 0.1.0</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    ExSHalos
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../pyexshalos.html">pyExSHalos</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/mock.html">Mock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/theory.html">Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules/utils.html">Utils</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/Voivodic/ExSHalos" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pyexshalos.theory</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module compute some theoretical quantities.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="c1"># Get the mass of each cell given its size</span>
<div class="viewcode-block" id="Get_Mcell">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Mcell">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Mcell</span><span class="p">(</span><span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span> <span class="n">Lc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the mass of a cell in the density grid.</span>

<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param Lc: Size of each cell in Mpc/h. Fiducial value: 2.0</span>
<span class="sd">    :type Lc: float</span>

<span class="sd">    :return: Mass of the cell in units of solar masses per h.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">2.775e+11</span><span class="o">*</span><span class="n">Om0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span></div>


<span class="c1"># Get the size of each cell given its mass</span>
<div class="viewcode-block" id="Get_Lc">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Lc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Lc</span><span class="p">(</span><span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span> <span class="n">Mcell</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.5e+10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the size of each cell given its mass.</span>

<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param Mcell: Mass of the cell in units of solar masses per h. Fiducial value: 8.5e+10</span>
<span class="sd">    :type Mcell: float</span>

<span class="sd">    :return: Size of the cell in Mpc/h.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Mcell</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.775e+11</span> <span class="o">*</span> <span class="n">Om0</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span></div>


<span class="c1"># Get Om at any redshift</span>
<div class="viewcode-block" id="Get_Omz">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Omz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Omz</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value of the matter overdensity at a given redshift.</span>

<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Matter overdensity at redshift z.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Om0</span><span class="p">))</span></div>


<span class="c1"># Get delta_c (critical matter overdensity for halo formation) at any redshift</span>
<div class="viewcode-block" id="Get_deltac">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_deltac">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_deltac</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value of delta_c (matter density contrast for halo formation) following a fit.</span>

<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Value of delta_c at redshift z.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.686</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Get_Omz</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Om0</span><span class="p">),</span> <span class="mf">0.0055</span><span class="p">)</span></div>


<span class="c1"># Get H(z) (Hubble constant at z)</span>
<div class="viewcode-block" id="Get_Hz">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Hz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Hz</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the Hubble function, in units of 100*h, at a given redshift.</span>

<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Hubble function in units of 100*h at redshift z.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Om0</span><span class="p">))</span></div>


<span class="c1"># Get H(a) (Hubble constant at a)</span>
<div class="viewcode-block" id="Get_Ha">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Ha">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Ha</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the Hubble function, in units of 100*h, at a given scale factor.</span>

<span class="sd">    :param a: Scale factor. Fiducial value: 1.0</span>
<span class="sd">    :type a: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Hubble function in units of 100*h at scale factor a.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Om0</span><span class="p">))</span></div>


<span class="c1"># Get dH(a) (derivative of H(a) with respect to a)</span>
<div class="viewcode-block" id="Get_dHa">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_dHa">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_dHa</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the derivative of the Hubble&#39;s function, with respect to a in units of 100*h, at a given scale factor.</span>

<span class="sd">    :param a: Scale factor. Fiducial value: 1.0</span>
<span class="sd">    :type a: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Derivative of the Hubble&#39;s function in units of 100*h at scale factor a.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">Get_Ha</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Om0</span><span class="p">)</span></div>


<span class="c1"># Get the growth rate at z</span>
<div class="viewcode-block" id="Get_fz">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_fz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_fz</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the growth rate at a given redshift.</span>

<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Growth rate at redshift z.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Get_Omz</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Om0</span><span class="p">),</span> <span class="mf">0.5454</span><span class="p">)</span></div>


<span class="c1"># Define the system of differential equations used to compute the growth function</span>
<div class="viewcode-block" id="Growth_eq">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Growth_eq">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Growth_eq</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the system of differential equations used to compute the growth function.</span>

<span class="sd">    :param y: Tuple containing the density contrast (d) and its derivative (v).</span>
<span class="sd">    :type y: tuple of float</span>
<span class="sd">    :param a: Scale factor. Fiducial value.</span>
<span class="sd">    :type a: float</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>

<span class="sd">    :return: Array containing the derivatives of density contrast and its velocity.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">v</span><span class="p">,</span>
        <span class="o">-</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="n">a</span> <span class="o">+</span> <span class="n">Get_dHa</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Om0</span><span class="p">)</span><span class="o">/</span><span class="n">Get_Ha</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Om0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">Om0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Get_Ha</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Om0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">d</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">dydt</span></div>



<span class="c1"># Return the growth function</span>
<div class="viewcode-block" id="Get_Dz">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Get_Dz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Get_Dz</span><span class="p">(</span><span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span> <span class="n">zmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">zmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nzs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the growth function over a range of redshifts.</span>

<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param zmax: Maximum redshift to consider. Fiducial value: 1000</span>
<span class="sd">    :type zmax: float</span>
<span class="sd">    :param zmin: Minimum redshift to consider. Fiducial value: -0.5</span>
<span class="sd">    :type zmin: float</span>
<span class="sd">    :param nzs: Number of redshift steps. Fiducial value: 1000</span>
<span class="sd">    :type nzs: int</span>

<span class="sd">    :return: Dictionary with the keys</span>
<span class="sd">             - &quot;z&quot;: Ndarray with redshifts</span>
<span class="sd">             = &quot;a&quot;: Ndarray with scale factors</span>
<span class="sd">             - &quot;Dz&quot; Ndarray with growth factors</span>
<span class="sd">             - &quot;dDz&quot;: Ndarray with derivatives of the growth factor</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Set the initial conditions</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">zmax</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">zmin</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)),</span> <span class="n">nzs</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">d0</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dd0</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="n">d0</span><span class="p">,</span> <span class="n">dd0</span><span class="p">]</span>

    <span class="c1"># Solve the Growth function equation</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">Growth_eq</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Om0</span><span class="p">,))</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Dz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;dDz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Window (top-hat) function in Fourier space</span>
<div class="viewcode-block" id="Wth">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Wth">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Wth</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the top-hat window function in Fourier space.</span>

<span class="sd">    :param k: Wavenumber.</span>
<span class="sd">    :type k: numpy.ndarray</span>
<span class="sd">    :param R: Smoothing radius.</span>
<span class="sd">    :type R: float</span>

<span class="sd">    :return: Window function value.</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">R</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">R</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Compute the variance of the linear density field</span>
<div class="viewcode-block" id="Compute_sigma">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Compute_sigma">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Compute_sigma</span><span class="p">(</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">R</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the variance of the density field.</span>

<span class="sd">    :param k: Wavenumbers of the power spectrum.</span>
<span class="sd">    :type k: numpy.ndarray</span>
<span class="sd">    :param P: Power spectrum.</span>
<span class="sd">    :type P: numpy.ndarray</span>
<span class="sd">    :param R: Smoothing radius (used to compute the mass). Fiducial value: None</span>
<span class="sd">    :type R: Optional[numpy.ndarray]</span>
<span class="sd">    :param M: Mass. Fiducial value: None</span>
<span class="sd">    :type M: Optional[numpy.ndarray]</span>
<span class="sd">    :param Om0: Omega matter at z=0 (used to compute the mass). Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>

<span class="sd">    :return: Variance of the density field on the given scales.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">simpson</span>

    <span class="c1"># Compute R(M) if R is not provided</span>
    <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You have to provide either the mass array (M) or the radius array (R)!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">2.775e+11</span> <span class="o">*</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Evaluate sigma</span>
    <span class="n">Nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nr</span><span class="p">):</span>
        <span class="n">kt</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">Pt</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        
        <span class="n">sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">simpson</span><span class="p">(</span><span class="n">Pt</span> <span class="o">*</span> <span class="n">kt</span> <span class="o">*</span> <span class="n">kt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Wth</span><span class="p">(</span><span class="n">kt</span><span class="p">,</span> <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">kt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sigma</span></div>


<span class="c1"># Compute the derivative of sigma with respect to M</span>
<div class="viewcode-block" id="dlnsdlnm">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.dlnsdlnm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dlnsdlnm</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the derivative of the logarithm of sigma with respect to the logarithm of mass using finite differences.</span>

<span class="sd">    :param M: Mass array.</span>
<span class="sd">    :type M: numpy.ndarray</span>
<span class="sd">    :param sigma: Variance array.</span>
<span class="sd">    :type sigma: numpy.ndarray</span>

<span class="sd">    :return: Array containing the derivatives of ln(sigma) with respect to ln(M).</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">))</span>

    <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">resp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Multiplicity function</span>
<div class="viewcode-block" id="fh">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.fh">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fh</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the halo mass function (HMF) based on different models.</span>

<span class="sd">    :param s: Variance of the density field.</span>
<span class="sd">    :type s: numpy.ndarray</span>
<span class="sd">    :param model: HMF model to use (0: Press-Schechter, 1: Sheth-Tormen, 2: Tinker, 3: Linear Diffusive Barrier).</span>
<span class="sd">                  Can also be a string identifier (&quot;PS&quot;, &quot;ST&quot;, &quot;Tinker&quot;, &quot;2LDB&quot;). Fiducial value: &quot;PS&quot;</span>
<span class="sd">    :type model: Union[int, str]</span>
<span class="sd">    :param theta: Model parameters. For Sheth-Tormen: [a, b, p], for Tinker: Delta, for Linear Diffusive Barrier: [b, D, dv, J_max].</span>
<span class="sd">    :type theta: Optional[Union[float, np.ndarray]]</span>
<span class="sd">    :param delta_c: Critical density for collapse. Fiducial value: None </span>
<span class="sd">    :type delta_c: Optional[float]</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>

<span class="sd">    :return: Array containing the multiplicity function.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">binom</span>

    <span class="c1"># Compute critical density if it was not given</span>
    <span class="k">if</span> <span class="n">delta_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta_c</span> <span class="o">=</span> <span class="n">Get_deltac</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c1"># Press-Schechter</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span> <span class="s2">&quot;1SB&quot;</span><span class="p">]:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Sheth-Tormen</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;elliptical&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">binom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">B</span> <span class="o">*</span> <span class="n">B</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>

    <span class="c1"># Tinker</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tinker&quot;</span><span class="p">,</span> <span class="s2">&quot;tinker&quot;</span><span class="p">,</span> <span class="s2">&quot;TINKER&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Delta</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Delta</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="k">if</span> <span class="n">Delta</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">B</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">0.482</span><span class="p">,</span> <span class="mf">1.97</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">1.228</span>
        <span class="k">elif</span> <span class="n">Delta</span> <span class="o">==</span> <span class="mi">300</span><span class="p">:</span>
            <span class="n">B</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">0.466</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">,</span> <span class="mf">1.310</span>
        <span class="k">elif</span> <span class="n">Delta</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">B</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="mf">0.494</span><span class="p">,</span> <span class="mf">2.30</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">,</span> <span class="mf">1.403</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="n">f</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">))</span>

    <span class="c1"># Linear Diffusive Barrier</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;2LDB&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.71</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">+</span> <span class="n">dv</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Compute the halo mass function</span>
<div class="viewcode-block" id="dlnndlnm">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.dlnndlnm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dlnndlnm</span><span class="p">(</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sigma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the logarithmic derivative of the halo mass function with respect to mass.</span>

<span class="sd">    :param M: Mass array.</span>
<span class="sd">    :type M: numpy.ndarray</span>
<span class="sd">    :param sigma: Variance of the density field. Fiducial value: None</span>
<span class="sd">    :type sigma: Optional[numpy.ndarray]</span>
<span class="sd">    :param model: HMF model to use (0: Press-Schechter, 1: Sheth-Tormen, 2: Tinker, 3: Linear Diffusive Barrier).</span>
<span class="sd">                  Can also be a string identifier (&quot;PS&quot;, &quot;ST&quot;, &quot;Tinker&quot;, &quot;2LDB&quot;). Fiducial value: &quot;PS&quot;</span>
<span class="sd">    :type model: Union[int, str]</span>
<span class="sd">    :param theta: Model parameters. For Sheth-Tormen: [a, b, p], for Tinker: Delta, for Linear Diffusive Barrier: [b, D, dv, J_max].</span>
<span class="sd">    :type theta: Optional[Union[float, np.ndarray]]</span>
<span class="sd">    :param delta_c: Critical density for collapse. Fiducial value: None</span>
<span class="sd">    :type delta_c: Optional[float]</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param k: Wavenumbers of the power spectrum (required if sigma is None). Fiducial value: None</span>
<span class="sd">    :type k: Optional[numpy.ndarray]</span>
<span class="sd">    :param P: Power spectrum (required if sigma is None). Fiducial value: None</span>
<span class="sd">    :type P: Optional[numpy.ndarray]</span>

<span class="sd">    :return: Halo mass function.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rhoc</span> <span class="o">=</span> <span class="mf">2.775e+11</span>
    <span class="n">rhom</span> <span class="o">=</span> <span class="n">Om0</span> <span class="o">*</span> <span class="n">rhoc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Compute sigma if it was not given</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sigma or (k, P) must be provided!&quot;</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">Compute_sigma</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">fh</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">delta_c</span><span class="p">,</span> <span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhom</span> <span class="o">/</span> <span class="n">M</span> <span class="o">*</span> <span class="n">dlnsdlnm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>


<span class="c1"># Halo bias of first order</span>
<div class="viewcode-block" id="bh1">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.bh1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bh1</span><span class="p">(</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Lagrangian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the first-order halo bias (b1).</span>

<span class="sd">    :param M: Mass array.</span>
<span class="sd">    :type M: numpy.ndarray</span>
<span class="sd">    :param s: Variance of the linear density field. Fiducial value: None </span>
<span class="sd">    :type s: Optional[numpy.ndarray]</span>
<span class="sd">    :param model: HMF model to use (0: Press-Schechter, 1: Sheth-Tormen, 2: Tinker, 3: Linear Diffusive Barrier).</span>
<span class="sd">                  Can also be a string identifier (&quot;PS&quot;, &quot;ST&quot;, &quot;Tinker&quot;, &quot;2LDB&quot;). Fiducial value: None</span>
<span class="sd">    :type model: Union[int, str]</span>
<span class="sd">    :param theta: Model parameters. For Sheth-Tormen: [a, b, p], for Tinker: Delta, for Linear Diffusive Barrier: [b, D, dv, J_max].</span>
<span class="sd">    :type theta: Optional[Union[float, np.ndarray]]</span>
<span class="sd">    :param delta_c: Critical density for collapse. Fiducial value: None</span>
<span class="sd">    :type delta_c: Optional[float]</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param k: Wavenumbers of the power spectrum (required if s is None). Fiducial value: None</span>
<span class="sd">    :type k: Optional[numpy.ndarray]</span>
<span class="sd">    :param P: Power spectrum (required if s is none). Fiducial value: None</span>
<span class="sd">    :type P: Optional[numpy.ndarray]</span>
<span class="sd">    :param Lagrangian: Whether to compute the Lagrangian bias.</span>
<span class="sd">    :type Lagrangian: bool</span>

<span class="sd">    :return: First-order halo bias (b1).</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">binom</span>

    <span class="c1"># Compute sigma if it was not given</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;s or (k, P) must be provided!&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Compute_sigma</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># Compute delta_c if it was not given</span>
    <span class="k">if</span> <span class="n">delta_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta_c</span> <span class="o">=</span> <span class="n">Get_deltac</span><span class="p">(</span><span class="n">Get_Omz</span><span class="p">(</span><span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">))</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c1"># Press-Schechter</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span> <span class="s2">&quot;1SB&quot;</span><span class="p">]:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_c</span>

    <span class="c1"># Sheth-Tormen</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;elliptical&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>

        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">binom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">)))</span>

    <span class="c1"># Tinker</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tinker&quot;</span><span class="p">,</span> <span class="s2">&quot;tinker&quot;</span><span class="p">,</span> <span class="s2">&quot;TINKER&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Del</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Del</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Del</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.24</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.44</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">0.88</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.183</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">0.019</span> <span class="o">+</span> <span class="mf">0.107</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.19</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">2.4</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="c1"># Linear Diffusive Barrier</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;2LDB&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.71</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">+</span> <span class="n">dv</span>

        <span class="c1"># Halos</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">-=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">dt</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">J_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">+</span> <span class="n">resp</span> <span class="o">/</span> <span class="n">tmp</span>

    <span class="c1"># Convert to Lagrangian bias if needed</span>
    <span class="k">if</span> <span class="n">Lagrangian</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">-=</span> <span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Halo bias of second order</span>
<div class="viewcode-block" id="bh2">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.bh2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bh2</span><span class="p">(</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Lagrangian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">b1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the second-order halo bias (b2).</span>

<span class="sd">    :param M: Mass array.</span>
<span class="sd">    :type M: numpy.ndarray</span>
<span class="sd">    :param s: Variance of the density field. Fiducial value: None</span>
<span class="sd">    :type s: Optional[numpy.ndarray]</span>
<span class="sd">    :param model: HMF model to use (0: Press-Schechter, 1: Sheth-Tormen, 2: Matteo, 3: Lazeyras).</span>
<span class="sd">                  Can also be a string identifier (&quot;PS&quot;, &quot;ST&quot;, &quot;Matteo&quot;, &quot;Lazeyras&quot;). Fiducial value: &quot;PS&quot;</span>
<span class="sd">    :type model: Union[int, str]</span>
<span class="sd">    :param theta: Model parameters. For Sheth-Tormen: [a, b, p], for Matteo: b1, for Lazeyras: b1.</span>
<span class="sd">    :type theta: Optional[Union[float, np.ndarray]]</span>
<span class="sd">    :param delta_c: Critical density for collapse. Fiducial value: None</span>
<span class="sd">    :type delta_c: Optional[float]</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param k: Wavenumbers of the power spectrum (required if s is None). Fiducial value: None</span>
<span class="sd">    :type k: Optional[numpy.ndarray]</span>
<span class="sd">    :param P: Power spectrum (required if s is None). Fiducial value: None</span>
<span class="sd">    :type P: Optional[numpy.ndarray]</span>
<span class="sd">    :param Lagrangian: Whether to compute the Lagrangian bias.</span>
<span class="sd">    :type Lagrangian: bool</span>
<span class="sd">    :param b1: First-order halo bias (used in Matteo&#39;s and Lazeyras&#39;s models). Fiducial value: None</span>
<span class="sd">    :type b1: Optional[numpy.ndarray]</span>

<span class="sd">    :return: Array containing the second-order halo bias values (b2).</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">binom</span>

    <span class="c1"># Compute the variance of the linear density field if it was not given</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Compute_sigma</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># Compute the critical density if it was not given</span>
    <span class="k">if</span> <span class="n">delta_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta_c</span> <span class="o">=</span> <span class="n">Get_deltac</span><span class="p">(</span><span class="n">Get_Omz</span><span class="p">(</span><span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">))</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c1"># Press-Schechter</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span> <span class="s2">&quot;1SB&quot;</span><span class="p">]:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">delta_c</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span> <span class="o">/</span> <span class="n">delta_c</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Sheth-Tormen</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;elliptical&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>

        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">binom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>
        <span class="n">BP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">B</span> <span class="o">/</span> <span class="n">S</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">S</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">B</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">BP</span><span class="p">)</span>

    <span class="c1"># Matteo</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;matteo&quot;</span><span class="p">,</span> <span class="s2">&quot;Matteo&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">bh1</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">330</span><span class="p">,</span> <span class="n">delta_c</span><span class="o">=</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">Lagrangian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.09143</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">0.7093</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.2607</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">-</span> <span class="mf">0.3469</span>

    <span class="c1"># Lazeyras</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Lazeyras&quot;</span><span class="p">,</span> <span class="s2">&quot;lazeyras&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">bh1</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">330</span><span class="p">,</span> <span class="n">delta_c</span><span class="o">=</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">Lagrangian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="mf">0.412</span> <span class="o">-</span> <span class="mf">2.143</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="mf">0.929</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.008</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Lagrangian</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">bh1</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">delta_c</span><span class="o">=</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">Lagrangian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">21.0</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">resp</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Halo bias of third order</span>
<div class="viewcode-block" id="bh3">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.bh3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bh3</span><span class="p">(</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Om0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Lagrangian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">bs2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the third-order halo bias (b3).</span>

<span class="sd">    :param M: Mass array.</span>
<span class="sd">    :type M: numpy.ndarray</span>
<span class="sd">    :param s: Variance of the density field. Fiducial value: None</span>
<span class="sd">    :type s: Optional[numpy.ndarray]</span>
<span class="sd">    :param model: HMF model to use (0: Press-Schechter, 1: Sheth-Tormen).</span>
<span class="sd">                  Can also be a string identifier (&quot;PS&quot;, &quot;ST&quot;). Fiducial value: &quot;PS&quot;</span>
<span class="sd">    :type model: Union[int, str]</span>
<span class="sd">    :param theta: Model parameters. For Sheth-Tormen: [a, b, p].</span>
<span class="sd">    :type theta: Optional[Union[float, np.ndarray]]</span>
<span class="sd">    :param delta_c: Critical density for collapse. Fiducial value: None</span>
<span class="sd">    :type delta_c: Optional[float]</span>
<span class="sd">    :param Om0: Omega matter at z=0. Fiducial value: 0.31</span>
<span class="sd">    :type Om0: float</span>
<span class="sd">    :param z: Redshift. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param k: Wavenumbers of the power spectrum (required if s is None). Fiducial value: None</span>
<span class="sd">    :type k: Optional[numpy.ndarray]</span>
<span class="sd">    :param P: Power spectrum (required if s is None). Fiducial value: None</span>
<span class="sd">    :type P: Optional[numpy.ndarray]</span>
<span class="sd">    :param Lagrangian: Whether to compute the Lagrangian bias.</span>
<span class="sd">    :type Lagrangian: bool</span>
<span class="sd">    :param bs2: Second-order halo bias. Fiducial value: 0.0</span>
<span class="sd">    :type bs2: float</span>

<span class="sd">    :return: Array containing the third-order halo bias values (b3).</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">binom</span>

    <span class="c1"># Compute the variance of the linear density grid if it was not given</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Compute_sigma</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># Compute the critical density if it was not given</span>
    <span class="k">if</span> <span class="n">delta_c</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">delta_c</span> <span class="o">=</span> <span class="n">Get_deltac</span><span class="p">(</span><span class="n">Get_Omz</span><span class="p">(</span><span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">))</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c1"># Press-Schechter</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;PS&quot;</span><span class="p">,</span> <span class="s2">&quot;1SB&quot;</span><span class="p">]:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">delta_c</span> <span class="o">/</span> <span class="n">S</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="n">S</span> <span class="o">/</span> <span class="n">delta_c</span>

    <span class="c1"># Sheth-Tormen</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ST&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;elliptical&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>

        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">binom</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>
        <span class="n">BP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_c</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">B</span> <span class="o">/</span> <span class="n">S</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">B</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">B</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="n">BP</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">BP</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Lagrangian</span><span class="p">:</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">bh2</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">delta_c</span><span class="o">=</span><span class="n">delta_c</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">Lagrangian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="n">resp</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">bs2</span>

    <span class="k">return</span> <span class="n">resp</span></div>


<span class="c1"># Compute the power spectra using CLPT at first order</span>
<div class="viewcode-block" id="CLPT_Powers">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.CLPT_Powers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CLPT_Powers</span><span class="p">(</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">Lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">kmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">nmin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">nmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the power spectra of the operators using Convolution Lagrangian Perturbation Theory (CLPT).</span>

<span class="sd">    :param k: Wavenumber of the power spectrum.</span>
<span class="sd">    :type k: numpy.ndarray</span>
<span class="sd">    :param P: Linear power spectrum.</span>
<span class="sd">    :type P: numpy.ndarray</span>
<span class="sd">    :param Lambda: Scale to be used to smooth the power spectrum. Fiducial value: 0.7</span>
<span class="sd">    :type Lambda: float</span>
<span class="sd">    :param kmax: Maximum wavenumber of the outputs. Fiducial value: 0.7</span>
<span class="sd">    :type kmax: float</span>
<span class="sd">    :param nmin: Minimum order used in the full computation of the terms of the expansion. Fiducial value: 5</span>
<span class="sd">    :type nmin: int</span>
<span class="sd">    :param nmax: Maximum order used in the Limber approximation of the terms of the expansion. Fiducial value: 10</span>
<span class="sd">    :type nmax: int</span>
<span class="sd">    :param verbose: Whether to output information in the C code. Fiducial value: False</span>
<span class="sd">    :type verbose: bool</span>

<span class="sd">    :return: Dictionary with the power spectra of the operators:</span>
<span class="sd">             - &quot;k&quot;: Ndarray with the wavenumbers</span>
<span class="sd">             - &quot;Plin&quot;: Ndarray with linear power spectrum used as input</span>
<span class="sd">             - &quot;P11&quot;: Ndarray with result for the 11 power spectrum</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Call the c function that compute the CLPT</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.lib.analytical</span><span class="w"> </span><span class="kn">import</span> <span class="n">clpt_compute</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">clpt_compute</span><span class="p">(</span>
        <span class="n">k</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="n">P</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">Lambda</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">kmax</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">nmin</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">nmax</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># Compute the generalized corraletion functions (Xi_lm)</span>
<div class="viewcode-block" id="Xi_lm">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Xi_lm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Xi_lm</span><span class="p">(</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">Lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">mk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">mr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">K</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
    <span class="n">Rmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the generalized correlation functions (Xi_lm).</span>

<span class="sd">    :param r: Radial distances for the output.</span>
<span class="sd">    :type r: numpy.ndarray</span>
<span class="sd">    :param k: Wavenumber of the power spectrum.</span>
<span class="sd">    :type k: numpy.ndarray</span>
<span class="sd">    :param P: Linear power spectrum.</span>
<span class="sd">    :type P: numpy.ndarray</span>
<span class="sd">    :param Lambda: Scale to be used to smooth the power spectrum. Fiducial value: 0.7</span>
<span class="sd">    :type Lambda: float</span>
<span class="sd">    :param l: Order of the spherical Bessel&#39;s function. Fiducial value: 0</span>
<span class="sd">    :type l: int</span>
<span class="sd">    :param mk: Power of k in the integral. Fiducial value: 2</span>
<span class="sd">    :type mk: int</span>
<span class="sd">    :param mr: Power of r in the integral. Fiducial value: 0</span>
<span class="sd">    :type mr: int</span>
<span class="sd">    :param K: Number of points used by the Gaussian smooth. Fiducial value: 11</span>
<span class="sd">    :type K: int</span>
<span class="sd">    :param alpha: Value of alpha used by the Gaussian smooth. Fiducial value: 4.0</span>
<span class="sd">    :type alpha: float</span>
<span class="sd">    :param Rmax: Maximum radius for the smoothing. Fiducial value: 1.0</span>
<span class="sd">    :type Rmax: float</span>
<span class="sd">    :param verbose: Whether to output information in the C code. Fiducial value: False</span>
<span class="sd">    :type verbose: bool</span>

<span class="sd">    :return: The generalized correlation function :math: &#39;xi_{lm} = int dk k^{mk} r^{mr} P(k) j_l(kr)&#39;.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Call the c function that compute the Xi_lm</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.lib.analytical</span><span class="w"> </span><span class="kn">import</span> <span class="n">xilm_compute</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">xilm_compute</span><span class="p">(</span>
        <span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="n">k</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="n">P</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">Lambda</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">l</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">mk</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">mr</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">K</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">Rmax</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span></div>


<span class="c1"># Compute the 1-loop matter or galaxy power spectrum using classPT</span>
<div class="viewcode-block" id="Pgg_EFTofLSS">
<a class="viewcode-back" href="../../modules/theory.html#pyexshalos.theory.Pgg_EFTofLSS">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Pgg_EFTofLSS</span><span class="p">(</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">IR_resummation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">RSD</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">AP</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">Om_fid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.31</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">ls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="n">pk_mult</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">OUT_MULT</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">h_units</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">vectorized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the 1-loop matter or galaxy power spectrum using classPT.</span>

<span class="sd">    :param k: Wavenumbers of the power spectrum (need to run CLASS-PT). Fiducial value: None</span>
<span class="sd">    :type k: Optional[numpy.ndarray]</span>
<span class="sd">    :param parameters: Cosmological parameters used by CLASS. Fiducial value: {}</span>
<span class="sd">    :type parameters: dict</span>
<span class="sd">    :param b: Values of the bias parameters (b1, b2, bG2, bGamma3, b4). Fiducial value: None</span>
<span class="sd">    :type b: Optional[numpy.ndarray]</span>
<span class="sd">    :param cs: Values of the stochastic parameters. 1D or 2D (multitracers) array. Fiducial value: None</span>
<span class="sd">    :type cs: Optional[numpy.ndarray]</span>
<span class="sd">    :param c: Values of the counterterms. 1D or 2D (multitracers) array. Fiducial value: None</span>
<span class="sd">    :type c: Optional[numpy.ndarray]</span>
<span class="sd">    :param IR_resummation: Option to do the IR resummation of the spectrum. Fiducial value: True</span>
<span class="sd">    :type IR_resummation: bool</span>
<span class="sd">    :param cb: Option to add baryons. Fiducial value: True</span>
<span class="sd">    :type cb: bool</span>
<span class="sd">    :param RSD: Option to give the power spectrum in redshift space. Fiducial value: True</span>
<span class="sd">    :type RSD: bool</span>
<span class="sd">    :param AP: Option to use the Alcock-Paczynski (AP) effect. Fiducial value: False</span>
<span class="sd">    :type AP: bool</span>
<span class="sd">    :param Om_fid: Omega matter fiducial for the AP correction. Fiducial value: 0.31</span>
<span class="sd">    :type Om_fid: float</span>
<span class="sd">    :param z: Redshift of the power spectrum. Fiducial value: 0.0</span>
<span class="sd">    :type z: float</span>
<span class="sd">    :param ls: The multipoles to be computed [0, 2, 4]. List or int.</span>
<span class="sd">    :type ls: Union[List[int], int]</span>
<span class="sd">    :param pk_mult: Multipoles of the power spectrum (don&#39;t need CLASS-PT). Fiducial value: None</span>
<span class="sd">    :type pk_mult: Optional[numpy.ndarray]</span>
<span class="sd">    :param fz: Growth rate at redshift z. Fiducial value: None</span>
<span class="sd">    :type fz: Optional[float]</span>
<span class="sd">    :param OUT_MULT: Whether output multipoles. Fiducial value: False</span>
<span class="sd">    :type OUT_MULT: bool</span>
<span class="sd">    :param h_units: Whether to use h-units. Fiducial value: True</span>
<span class="sd">    :type h_units: bool</span>
<span class="sd">    :param vectorized: Whether to use vectorized operations. Fiducial value: False</span>
<span class="sd">    :type vectorized: bool</span>

<span class="sd">    :return: Dictionary with the computed power spectra and additional information.</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Compute the power spectra using classPT</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pk_mult</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
	        <span class="kn">from</span><span class="w"> </span><span class="nn">classy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Class</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;classy module is not installed. Please install it using pip: pip install classy&quot;</span><span class="p">)</span>

        <span class="c1">#Set the parameters</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Class</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A_s&#39;</span><span class="p">:</span><span class="mf">2.089e-9</span><span class="p">,</span> <span class="s1">&#39;n_s&#39;</span><span class="p">:</span><span class="mf">0.9649</span><span class="p">,</span> <span class="s1">&#39;tau_reio&#39;</span><span class="p">:</span><span class="mf">0.052</span><span class="p">,</span> <span class="s1">&#39;omega_b&#39;</span><span class="p">:</span><span class="mf">0.02237</span><span class="p">,</span> <span class="s1">&#39;omega_cdm&#39;</span><span class="p">:</span><span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span><span class="mf">0.6736</span><span class="p">,</span> <span class="s1">&#39;YHe&#39;</span><span class="p">:</span><span class="mf">0.2425</span><span class="p">,</span> <span class="s1">&#39;N_ur&#39;</span><span class="p">:</span><span class="mf">2.0328</span><span class="p">,</span> <span class="s1">&#39;N_ncdm&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m_ncdm&#39;</span><span class="p">:</span><span class="mf">0.06</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;z_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cb</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">AP</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">AP</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AP</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IR_resummation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">IR_resummation</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IR_resummation</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:</span><span class="s1">&#39;mPk&#39;</span><span class="p">,</span> <span class="s1">&#39;non linear&#39;</span><span class="p">:</span><span class="s1">&#39;PT&#39;</span><span class="p">,</span> <span class="s1">&#39;IR resummation&#39;</span><span class="p">:</span><span class="n">IR_resummation</span><span class="p">,</span> <span class="s1">&#39;Bias tracers&#39;</span><span class="p">:</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;cb&#39;</span><span class="p">:</span><span class="n">cb</span><span class="p">,</span> <span class="s1">&#39;RSD&#39;</span><span class="p">:</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;AP&#39;</span><span class="p">:</span><span class="n">AP</span><span class="p">,</span> <span class="s1">&#39;Omfid&#39;</span><span class="p">:</span><span class="n">Om_fid</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:</span><span class="s1">&#39;mPk&#39;</span><span class="p">,</span> <span class="s1">&#39;non linear&#39;</span><span class="p">:</span><span class="s1">&#39;PT&#39;</span><span class="p">,</span> <span class="s1">&#39;IR resummation&#39;</span><span class="p">:</span><span class="n">IR_resummation</span><span class="p">,</span> <span class="s1">&#39;Bias tracers&#39;</span><span class="p">:</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;cb&#39;</span><span class="p">:</span><span class="n">cb</span><span class="p">,</span> <span class="s1">&#39;RSD&#39;</span><span class="p">:</span><span class="s1">&#39;No&#39;</span><span class="p">})</span>
        <span class="n">M</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

        <span class="c1">#Compute the spectra of the basis</span>
        <span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You have to give an array of k where to compute the power spectrum&quot;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">h</span><span class="p">()</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">h</span>
        <span class="n">fz</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">scale_independent_growth_factor_f</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">M_mult</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_pk_mult</span><span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kh</span><span class="p">))</span>
       
        <span class="c1">#Save a dictionary with the spectra</span>
        <span class="n">pk_mult</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spectra_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Id2d2&quot;</span><span class="p">,</span> <span class="s2">&quot;Id2&quot;</span><span class="p">,</span> <span class="s2">&quot;IG2&quot;</span><span class="p">,</span> <span class="s2">&quot;Id2G2&quot;</span><span class="p">,</span> <span class="s2">&quot;IG2G2&quot;</span><span class="p">,</span> <span class="s2">&quot;FG2&quot;</span><span class="p">,</span> <span class="s2">&quot;ctr&quot;</span><span class="p">,</span> <span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop&quot;</span><span class="p">]</span>
        <span class="n">spectra_ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra_label</span><span class="p">)):</span>
            <span class="n">pk_mult</span><span class="p">[</span><span class="n">spectra_label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">M_mult</span><span class="p">[</span><span class="n">spectra_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">spectra_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FG2_0b1&quot;</span><span class="p">,</span> <span class="s2">&quot;FG2_0&quot;</span><span class="p">,</span> <span class="s2">&quot;FG2_2&quot;</span><span class="p">,</span> <span class="s2">&quot;ctr_0&quot;</span><span class="p">,</span> <span class="s2">&quot;ctr_2&quot;</span><span class="p">,</span> <span class="s2">&quot;ctr_4&quot;</span><span class="p">]</span>
            <span class="n">spectra_ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span> <span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra_label</span><span class="p">)):</span>
                <span class="n">pk_mult</span><span class="p">[</span><span class="n">spectra_label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">M_mult</span><span class="p">[</span><span class="n">spectra_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>	
            <span class="n">spectra_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lin_0_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;lin_0_vd&quot;</span><span class="p">,</span> <span class="s2">&quot;lin_0_dd&quot;</span><span class="p">,</span> <span class="s2">&quot;lin_2_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;lin_2_vd&quot;</span><span class="p">,</span> <span class="s2">&quot;lin_4_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_0_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_0_vd&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_0_dd&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_2_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_2_vd&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_2_dd&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_4_vv&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_4_vd&quot;</span><span class="p">,</span> <span class="s2">&quot;1loop_4_dd&quot;</span><span class="p">,</span> <span class="s2">&quot;Idd2_0&quot;</span><span class="p">,</span> <span class="s2">&quot;Id2_0&quot;</span><span class="p">,</span> <span class="s2">&quot;IdG2_0&quot;</span><span class="p">,</span> <span class="s2">&quot;IG2_0&quot;</span><span class="p">,</span> <span class="s2">&quot;Idd2_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Id2_2&quot;</span><span class="p">,</span> <span class="s2">&quot;IdG2_2&quot;</span><span class="p">,</span> <span class="s2">&quot;IG2_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Id2_4&quot;</span><span class="p">,</span> <span class="s2">&quot;IG2_4&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra_label</span><span class="p">)):</span>
                <span class="n">pk_mult</span><span class="p">[</span><span class="n">spectra_label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">M_mult</span><span class="p">[</span><span class="mi">15</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>	

    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fz</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fz</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">Om_fid</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Om_fid</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">Om_fid</span><span class="p">),</span> <span class="mf">0.5454</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_mult</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are not all spectra needed for the computations in redshift space&quot;</span><span class="p">)</span>

	<span class="c1">#Get the number of tracers</span>
    <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;You have to give an array with the values of the bias parameters&quot;</span><span class="p">)</span>
	
    <span class="k">if</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">vectorized</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">vectorized</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)):</span>
        <span class="n">Ntracers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">vectorized</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">cs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">if</span><span class="p">(</span><span class="n">vectorized</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">Ntracers</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ntracers</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

	<span class="c1">#Set all combinations of the bias parameters (b1, b2, bG2, bGamm3, b4)</span>
	<span class="c1">#(b1, b1^2, b2^2, b1*b2, b2, b1*bG2, bG2, b2*bG2, bG2^2, b1*bGamma3, bGamma3, b4, b1*b4, b1^2*b4)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">14</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ctrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">bias</span><span class="p">[:,</span> <span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">ctrs</span><span class="p">[:,</span> <span class="n">count</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cs</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">bias</span><span class="p">[:,</span> <span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ctrs</span><span class="p">[:,</span> <span class="n">count</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>		
    <span class="c1">#(b1^2, b1*b2, b1*bG2, b1*bGamma3, b2^2, bG2^2, b2*bG2)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ctrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">bias</span><span class="p">[:,</span><span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
                <span class="n">ctrs</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cs</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">bias</span><span class="p">[:,</span><span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
            <span class="n">ctrs</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

				
    <span class="c1">#Define the functions to compute each power spectra</span>
    <span class="c1">#Compute Pgg in real space</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pgg</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2d2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2G2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2G2&quot;</span><span class="p">])</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ctrs</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:])):</span>
            <span class="n">resp</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span>

    <span class="c1">#Compute the monopole of the power spectrum</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pgg_l0</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span>  <span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_0_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_0_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_0_vd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_0_vd&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_0_dd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_0_dd&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2d2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Idd2_0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2_0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IdG2_0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2_0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2G2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2G2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2_0b1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2_0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2_0b1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2_0&quot;</span><span class="p">])</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ctrs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_0&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="n">fz</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="mi">35</span><span class="o">/</span><span class="mf">8.0</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_4&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">9.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">fz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">7.0</span><span class="o">*</span><span class="n">fz</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">5.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="n">ind</span><span class="p">,:])</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">resp</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span>

    <span class="c1">#Compute the quadrupole of the power spectrum</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pgg_l2</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_2_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_2_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_2_vd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_2_vd&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_2_dd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Idd2_2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2_2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IdG2_2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2_2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="n">ind</span><span class="p">,:])</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;FG2_2&quot;</span><span class="p">])</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ctrs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_2&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="n">fz</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="mi">35</span><span class="o">/</span><span class="mf">8.0</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_4&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">70.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">fz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">165.0</span><span class="o">*</span><span class="n">fz</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">+</span> <span class="mf">99.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="n">ind</span><span class="p">,:])</span><span class="o">*</span><span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">693.0</span><span class="p">)</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">resp</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span>

    <span class="c1">#Compute the hexadecapole of the power spectrum</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pgg_l4</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;lin_4_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_4_vv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_4_vd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;1loop_4_dd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;Id2_4&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;IG2_4&quot;</span><span class="p">])</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ctrs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_4&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span> <span class="o">+</span> <span class="n">fz</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="mi">35</span><span class="o">/</span><span class="mf">8.0</span><span class="o">*</span><span class="n">pk_mult</span><span class="p">[</span><span class="s2">&quot;ctr_4&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">210.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span><span class="o">*</span><span class="n">fz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">390.0</span><span class="o">*</span><span class="n">fz</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">+</span> <span class="mf">143.0</span><span class="o">*</span><span class="n">bias</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="n">ind</span><span class="p">,:])</span><span class="o">*</span><span class="p">(</span><span class="mf">8.0</span><span class="o">/</span><span class="mf">5005.0</span><span class="p">)</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">,:,</span><span class="mi">2</span><span class="p">])):</span>
            <span class="n">resp</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span>

    <span class="c1">#Compute the spectra and save in the dictionary</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">RSD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">P</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Pgg_l0</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Pgg_l0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>	
        <span class="k">if</span><span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">P</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Pgg_l2</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Pgg_l2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>	
        <span class="k">if</span><span class="p">(</span><span class="mi">4</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">P</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Pgg_l4</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Pgg_l4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>	
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">*</span><span class="p">(</span><span class="n">Ntracers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntracers</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">P</span><span class="p">[:,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Pgg</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Pgg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>

    <span class="c1">#Output the spectra</span>
    <span class="k">if</span><span class="p">(</span><span class="n">OUT_MULT</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pk_mult</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;ctr&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;ctr_0&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;ctr_2&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;ctr_4&quot;</span><span class="p">):</span>
                <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk_mult</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_units</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk_mult</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">h_units</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span></div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Rodrigo Voivodic
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2025, Rodrigo Voivodic.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>