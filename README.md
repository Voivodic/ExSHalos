# ExSHalos

This is a python package that implements [ExSHalos](https://arxiv.org/abs/1906.06630) and many other utilities for cosmological analysis:
- Measurement of the power/bi/tri-spectra for any number of tracers in a box;
- Population of halos with galaxies using a HOD and split of galaxies for the creation of multi-tracer catalogues;
- Creation of density grid and catalogue of particles created by LPT;
- Computation of shifted Lagrangian operators;
- Computation of EFTofLSS, for multi-tracers, using [CLASS-PT](https://github.com/Michalychforever/CLASS-PT);
- Computation of simple theoretical quantities (e.g. growth function, growth rate, mass function, ...).

This library follows the functional programming paradigm! There are no classes, random operators nor custom types.

---

## Local installation (not recommended)

To install [pyExSHalos](https://github.com/Voivodic/ExSHalos) a few libraries are required:

### C requirements:
- [FFTW3](https://www.fftw.org/) (required for installation)
- [GSL/CBLAS](https://www.gnu.org/software/gsl/) (required for installation)
- [OpenMP](https://www.openmp.org/) (required for installation)

### Python requirements:
- [Numpy](https://numpy.org/) (required for installation and running)
- [setuptools](https://setuptools.pypa.io/en/latest/) (required for installation)
- [pip](https://pypi.org/project/pip/) (required for building)
- [scipy](https://scipy.org/) (required for running)

After all libraries were installed, you just need to
```bash
git clone https://github.com/Voivodic/ExSHalos.git
cd ExSHalos
pip install .
```

---

## Containarized installation (recommended)

This guide provides three methods for installing `ExSHalos` in an isolated, reproducible environment. This is the strongly recommended approach as it handles all system and Python dependencies for you.

### Prerequisites

You must have `git` and one of the following tools installed on your system:
*   [Docker](https://www.docker.com/get-started) (or a compatible alternative like [Podman](https://podman.io/))
*   [Apptainer](https://apptainer.org/docs/user/main/installation.html)
*   [Nix](https://nixos.org/download.html)

### Getting Started: Initial Setup

First, clone the repository and navigate into the project directory. All commands in the sections below assume you are running them from this `ExSHalos` directory.

```bash
git clone https://github.com/Voivodic/ExSHalos.git
cd ExSHalos
```

After completing the initial setup, choose **one** of the following methods to create your environment.

### Option 1: Docker

Docker allows you to build a container image with all dependencies included.

**1. Build the Image**

```bash
docker build -t your_image_name -f install/Dockerfile .
```
Replace `your_image_name` with the name you want to give your image.

**2. Run Your Code**

To run a Python script, mount your current directory into the container. The container will execute your script using its internal Python interpreter.

```bash
# This command runs 'your_script.py' inside the container
docker run --rm -v ./:/Workspace your_image_name your_script.py
```
Any files generated by your script will appear in your current directory on your host machine.

**3. Start an Interactive Shell**

If you want to explore the container's environment or run commands interactively, start a `bash` shell.

```bash
# This command overrides the default entrypoint to give you a shell
docker run --rm -it -v ./:/Workspace your_image_name 
```

### Option 2: Apptainer

Apptainer is a popular container runtime in scientific and HPC environments.

**1. Build the Image**

This command creates a single, executable container file (`exshalos.sif`).

```bash
# Building requires sudo or a --fakeroot setup
sudo apptainer build your_container_name.sif install/apptainer.def
```
Replace `your_container_name` with the name you want to give your container.

**2. Run Your Code**

To run a Python script, you can use the container directly as an executable.

```bash
./your_container_name.sif your_script.py
```

**3. Start an Interactive Shell**

To explore the container's environment:

```bash
apptainer shell your_container_name.sif
```

### Option 3: Nix

Nix allows you to create a reproducible development shell or run your code directly using the `flake.nix` file in this repository.

**1. Start an Ephemeral Shell**

This command downloads all dependencies and gives you a `bash` shell where `python` and the `pyexshalos` library are available. Differently from the other methods, this shell is not isolated from your base system, and you can still use all you programs.

```bash
nix develop install/.
```
Inside this shell, you can run your code directly: `python your_script.py`.

**2. Run a Script Directly**

To execute a script without first entering an interactive shell:

```bash
nix run install/. -- your_script.py
```
> **Note:** The `--` is important. It separates the arguments for `nix run` from the arguments for your script.

The `pyexshalos` package can also be used as a dependency in other Nix flakes. See the [Voivodic/nix-derivations](https://github.com/Voivodic/nix-derivations) repository for more information.

---

## Quick start

Using the python interface for ExSHalos is as simple as:

```python
    import numpy as np
    import pyexshalos as exh
    import pylab as pl

    # Load a linear matter power spectrum
    k, Pk = np.loadtxt("matter_power_spectrum.dat", unpack = True)

    # Create the halo catalogue using exshalos
    halos = exh.mock.Generate_Halos_Box_from_Pk(k, Pk, nd = 256, Lc = 4.0, Om0 = 0.31)

    # Measure the power spectrum
    grid = exh.simulation.Compute_Density_Grid(halos["posh"], nd = 256, L = 1024.0)
    Ph = exh.simulation.Compute_Power_Spectrum(grid, L = 1024.0)

    # Plot the power spectrum
    pl.errorbar(Ph["k"], Ph["Pk"], yerr = Ph["Pk"]/np.sqrt(Ph["Nk"]), lw = 3)

    pl.xscale("log")
    pl.yscale("log")
    pl.xlabel("k [$h/$Mpc]", fontsize=15)
    pl.ylabel("P(k)  [Mpc/$h/$]$^{3}$", fontsize=15)

    pl.savefig("Ph_example.pdf")
```

---

## Documentation

More information about the installation, the API, and some tutorials can be found at the [documentation](https://voivodic.github.io/ExSHalos/).

---

## TODO

Not necessarily in the priority order

### Code

- 🔄 **Creation of more tutorials**
- ✅ **Completion of the documentation**
- 📝 **Integration with the zig's building system**
- 📝 **Compilation of C/C++ libraries**
- 📝 **Creation of zig wrappers**
- ✅ **Creation of a Dockerfile, apptainer's definition file and nix's shell.nix file**

### Physics

- 📝 **Functions for the halo/void finder (simulation module)**
- 📝 **Function for the halo/void profile (simulation module)**
- 📝 **Computation of the growth factor in modified gravity (theory momdule)**
- 📝 **Computation of the spherical collapse in modified gravity (theory module)**
- 📝 **Fit of the split of galaxies for the creation of multi-tracer catalogues (utils module)**
- 📝 **Creation of halo catalogues in the lightcone (mock module)**
